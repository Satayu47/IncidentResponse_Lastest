"""
Test Claude API Key
===================

Quick test to verify your Claude API key works.
"""

import os
import sys
from pathlib import Path

# Fix Windows console encoding
if sys.platform == "win32":
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

sys.path.insert(0, str(Path(__file__).parent.parent))

def test_claude_key():
    """Test if Claude API key works."""
    
    api_key = os.getenv("ANTHROPIC_API_KEY")
    
    if not api_key:
        print("\n[ERROR] ANTHROPIC_API_KEY not set!")
        print("\nTo set it:")
        print("  $env:ANTHROPIC_API_KEY = 'sk-ant-your-key-here'")
        print("\nGet your key from: https://console.anthropic.com/")
        return False
    
    if not api_key.startswith("sk-ant-"):
        print("\n[WARNING] Key doesn't start with 'sk-ant-'")
        print("Make sure you copied the full key from Anthropic console")
        return False
    
    print(f"\n[INFO] Testing Claude API key...")
    print(f"Key format: {api_key[:10]}...{api_key[-4:]}")
    
    try:
        from src.llm_adapter import LLMAdapter
        
        print("[INFO] Initializing Claude adapter...")
        adapter = LLMAdapter(model="claude-3-5-sonnet-20241022", api_key=api_key)
        
        print("[INFO] Testing classification...")
        result = adapter.classify_incident(
            description="SQL injection vulnerability detected",
            context="",
            conversation_history=None
        )
        
        if result and result.get("incident_type"):
            print("\n[OK] Claude API key works!")
            print(f"   - Model: Claude 3.5 Sonnet")
            print(f"   - Test classification: {result.get('incident_type', 'Unknown')}")
            print(f"   - Confidence: {result.get('confidence', 0.0):.2f}")
            print("\n[OK] Ready to run baseline experiment!")
            return True
        else:
            print("\n[ERROR] API call succeeded but got unexpected response")
            return False
            
    except Exception as e:
        error_msg = str(e)
        print(f"\n[ERROR] Claude API test failed!")
        print(f"Error: {error_msg[:200]}")
        
        if "401" in error_msg or "authentication" in error_msg.lower():
            print("\n[INFO] This usually means:")
            print("  - Invalid API key")
            print("  - Key not activated yet")
            print("  - Wrong key format")
            print("\nCheck: https://console.anthropic.com/api-keys")
        
        elif "429" in error_msg or "rate limit" in error_msg.lower():
            print("\n[INFO] Rate limit hit - key works but wait a moment")
            return True  # Key is valid, just rate limited
        
        elif "quota" in error_msg.lower() or "billing" in error_msg.lower():
            print("\n[INFO] Quota/billing issue:")
            print("  - Check your free credit balance")
            print("  - Go to: https://console.anthropic.com/settings/billing")
        
        return False


def main():
    """Main entry point."""
    print("\n" + "="*70)
    print("Claude API Key Test")
    print("="*70)
    
    # Also check Gemini
    gemini_key = os.getenv("GEMINI_API_KEY")
    if gemini_key:
        print("\n[OK] Gemini API key is set")
    else:
        print("\n[WARNING] GEMINI_API_KEY not set")
        print("You'll need it for the experiment:")
        print("  $env:GEMINI_API_KEY = 'your-gemini-key'")
    
    # Test Claude
    success = test_claude_key()
    
    if success:
        print("\n" + "="*70)
        print("Next Steps:")
        print("="*70)
        print("1. Make sure GEMINI_API_KEY is set")
        print("2. Run: python scripts/run_llm_baseline_experiment.py --baseline claude")
        print("3. Generate visualizations after experiment completes")
        print("="*70 + "\n")
    else:
        print("\n" + "="*70)
        print("Troubleshooting:")
        print("="*70)
        print("1. Get key from: https://console.anthropic.com/")
        print("2. Make sure key starts with 'sk-ant-'")
        print("3. Set: $env:ANTHROPIC_API_KEY = 'sk-ant-your-key'")
        print("4. Try again!")
        print("="*70 + "\n")


if __name__ == "__main__":
    main()

